\documentclass[10pt,onecolumn,draftclsnofoot]{IEEEtran} %may need comma after
\usepackage{times}
\usepackage{graphicx}
\usepackage{array}
\usepackage{float}
\usepackage{geometry}
\usepackage{titling}
\usepackage{hyperref}
\usepackage{setspace}

\newgeometry{left=1.905cm, right=1.905cm}
%this is a comment
\title{ Project One, CS444, Spring 2018, Homework Group 10}
\author{Kamron Ebrahimi, Maximillian Schmidt \& Brendan Byers \\ ebrahimk, schmidtm, byersbr }
\date{\today}

\begin{document}

\begin{titlingpage}
\maketitle
\begin{abstract}
\begin{singlespace}
This report details the process of building the Linux Kernel and running the kernel on the Oregon State University, operating systems II server. To accomplish this task, the command line based, virtual machine, QEMU, was cloned and configured in order to produce a safe, experimental environment in which the Linux Kernel could be modified. This paper will walk the reader through the key components of configuring this environment. The team was able to successfully build the Kernel and boot the Kernel within the QEMU virtual machine.     %paper abstract here
\end{singlespace}
\end{abstract}
\end{titlingpage}


\tableofcontents

\newpage
\begin{singlespace}
\section{\bf  Commands Used}

  \normalfont \indent In order to run the Linux Kernel in a QEMU virtual machine a folder titled "10" was created with the following file path, /scratch/spring2018/10. A copy of the linux-yocto repository was then cloned and unzipped to the group 10 folder using the following commands from within the group 10 folder.
\hfill\break

  \begin{itemize}
    \item \textbf{wget http://git.yoctoproject.org/cgit.cgi/linux-yocto/snapshot/linux-yocto-3.19.2.zip }
    \item \textbf{unzip -q linux-yocto-3.19.2.zip}
  \end{itemize}
\hfill\break

  \normalfont \indent With the linux-yocto repository successfully cloned the QEMU environment needed to be set up and run. Some preliminary measures were required to ensure this was performed properly. First a script located at the file path /scratch/opt/environment-setup-i586-poky-linux was sourced. All members of group ten operate in the bash shell, thus this script at the aforementioned file path was used. To source this script the following command was executed from the root directory of os2.engr.oregonstate.edu.

\hfill\break
  \begin{itemize}
    \item \textbf{source /scratch/opt/environment-setup-i586-poky-linux}
  \end{itemize}
\hfill\break
  \normalfont \indent In order to ensure that the Makefile associated with the Linux Kernel executed properly, the file located at the file path /scratch/files/config-3.19.2-yocto-standard was copied to a newly created folder named ".config" located within the linux-yocto-3.19.2 folder. Additionally the starting Kernel image, bzImage-qemux86.bin and drive file core-image-lsb-sdk-qemux86.ext4 were copied within the linux-yocto-3.19.2 folder. To accomplish this the following commands were executed from within the linux-yocto-3.19.2 folder.

\hfill\break
  \begin{itemize}
    \item \textbf{cp /scratch/files/config-3.19.2-yocto-standard ./.config}
    \item \textbf{cp /scratch/files/bzImage-qemux86.bin .}
    \item \textbf{cp /scratch/files/core-image-lsb-sdk-qemux86.ext4 .}
  \end{itemize}
\hfill\break
  \normalfont \indent With the aforementioned preliminary configurations complete, the clone of the Linux Kernel could be compiled. The following command allocates four threads to build the Linux Kernel. A limit of the number of threads is used to ensure that no one group consumed too many computational resources on the shared os2.engr.oregonstate.edu server.
\hfill\break
  \begin{itemize}
    \item \textbf{make -j4 all}
  \end{itemize}
\hfill\break
  \normalfont \indent With the Kernel built, the last step was to boot the Kernel from within an instance of the QEMU virtual machine. First an instance of QEMU was executed on port 5510 of the os2 server using the following command:
\hfill\break
  \begin{itemize}
    \item \textbf{qemu-system-i386 -gdb tcp::5510 -S -nographic -kernel bzImage-qemux86.bin -drive file=core-image-lsb-sdk-qemux86.ext4,if=virtio -enable-kvm -net none -usb -localtime --no-reboot --append "root=/dev/vda rw console=ttyS0 debug"}
  \end{itemize}
\hfill\break
  \normalfont \indent Using GDB from another terminal window the Kernel could be executed. To complete this a group member had to connect via port 5510 via GDB to the QEMU virtual machine and execute the "vmlinux" process from within the linux-yocto-3.19.2 folder. The following chain of commands were used while an instance QEMU was running on port 5510, these commands were executed from within the group 10 folder.

  \hfill\break
  \begin{itemize}
    \item \textbf{\$GDB linux-yocto-3.14/vmlinux}
    \item \textbf{target remote :5510}
    \item \textbf{continue}
  \end{itemize}
\hfill\break

  \normalfont \indent The above commands create a gdb connection to port 5510 of the os2 server and enters the vmlinux file. The vmlinux executable when run hoists an instance of the Linux Kernel from within the QEMU virtual machine. By running the "continue" command from within the gdb connection, vmlinux is executed which boots the Kernel from within QEMU.


\newpage
\section{\bf  QEMU Command Explanation}

  \begin{itemize}
    \item \textbf{-gdb tcp::5510}
    \begin{itemize}
      \item This will cause QEMU to wait for a connection on a device, which in this case is a tcp port. The connection can also be UDP, pseudo TTY, or standard output. Using standard output allows you to start QEMU from within gdb and establish the connection with a pipe.
    \end{itemize}

    \item \textbf{-S}
    \begin{itemize}
      \item This signals to qemu to not start the CPU at startup.
    \end{itemize}

    \item \textbf{-nographic}
    \begin{itemize}
      \item This will start qemu with graphical output completely disabled. The emulated serial port will usually be redirected to the console.
    \end{itemize}

    \item \textbf{-kernel bzImage-qemux86.bin}
    \begin{itemize}
      \item  Points to the kernel image. This image can either be a standard linux kernel or a kernel in multiboot format.
    \end{itemize}

    \item \textbf{-drive file=core-image-lsb-sdk-qemux86.ext4,if=virtio -enable-kvm}
    \begin{itemize}
      \item The “-drive” defines a new drive, which includes creating the block driver and the guest device. Our drive in this case is “”.  Next, it checks if virtio is enabled and enables the kvm accordingly. Virtio is a virtualization standard that allows the guest to know that is is in a virtual environment.
    \end{itemize}

    \item \textbf{-net none}
    \begin{itemize}
      \item This is used to create an onboard Network Interface Card. In our case we don’t want to create any network interfaces for our kernel. If this option isn’t specified, then a single NIC is created.
    \end{itemize}

    \item \textbf{-usb}
    \begin{itemize}
      \item This flag will enable the usb driver for the guest vm.
    \end{itemize}

    \item \textbf{-localtime }
    \begin{itemize}
      \item This is used to specify that the vm should use local time. This flag has been depreciated as of qemu 2.12.0 and was replaced by the -rtc flag.
    \end{itemize}

    \item \textbf{--no-reboot}
    \begin{itemize}
      \item This will stop qemu from exiting when the guest shuts down. Instead, it will only stop the emulation.
    \end{itemize}

    \item \textbf{--append "root=/dev/vda rw console=ttyS0 debug"}
    \begin{itemize}
      \item This will tell the emulator to use the command line in quotes to be used as the kernel command line. This line here dictates the location of the root directory, what sort of console, and to boot in debug mode.
    \end{itemize}

  \end{itemize}


\section{\bf Git Log}
 	\begin{center}
 \begin{tabular}{||c c c||} 
 \hline
 Date & Author & Description \\
 \hline
 9/4/2018 & Maximillian Schmidt & Copied yocto VM files \\ 
 \hline
 9/4/2018 & Maximillian Schmidt & Created .config folder and moved config-3.19.2-yocto-standard file into .config \\
 \hline
 10/4/2018 & Maximillian Schmidt & Copied bzImage-qemux86.bin and core-image-lsb-sdk-qemux86.ext4 into yocto environment \\
 \hline
\end{tabular}
	\end{center}

\newpage
\section{\bf Work Log}
\normalfont \indent To track assignment submissions and homework workflow, a git repository was created. All tex and make files are organized within this repository. Below is a detailed repositroy log for project number one. The vast majority of work setting up the yocto-QEMU enviroment was performed at the beginning of week two. After the environment was configured and the Kernel was booted within the QEMU virtual machine each team member was briefed on the configuration process and work on the tex document was started. \hfill\break

        \begin{center}
                \input{changelog.tex}
        \end{center}


\end{singlespace}
\restoregeometry
\end{document}
